# WebSocket Subscriptions Guide

[![Monostate Logo](../Logo%20monostate%20completo%20png%20preto.png)](../README.md)

The Solana RPC Cache Worker supports real-time data updates via WebSocket subscriptions. This allows clients to receive notifications when specific Solana data changes, without needing to poll the HTTP endpoint repeatedly.

## Connecting

Establish a WebSocket connection to the root URL of your deployed worker:

```
wss://YOUR_WORKER_URL/
```

Replace `YOUR_WORKER_URL` with the actual URL of your deployed worker (e.g., `solana-rpc-cache-worker.your-subdomain.workers.dev` or your custom domain).

**Note on Authentication:** The WebSocket connection handshake (`wss://...`) itself does not use the `API_KEY`. However, when the worker processes a subscription, it fetches the necessary data using its configured `SOLANA_RPC_URL`. The security relies on the worker's environment being secure and the upstream RPC endpoint being correctly configured. The `API_KEY` protects the HTTP endpoint (`/` POST), preventing unauthorized clients from initiating subscriptions or making direct RPC calls via POST.

## Subscribing

Once connected, send a JSON message to subscribe to specific RPC method updates. The message should follow this format:

```json
{
  "jsonrpc": "2.0",
  "id": 1, // Your unique request ID
  "method": "subscribe",
  "params": {
    "method": "SOLANA_RPC_METHOD_TO_SUBSCRIBE_TO",
    "params": [
      // Parameters for the Solana RPC method
    ]
  }
}
```

- `id`: A unique identifier for your request. The server will use this ID in its confirmation response.
- `method`: Must be `"subscribe"`.
- `params.method`: The Solana JSON-RPC method you want to subscribe to (e.g., `"getSlot"`, `"getAccountInfo"`).
- `params.params`: An array containing the parameters for the specified Solana RPC method.

**Example: Subscribe to Slot Updates**

```json
{
  "jsonrpc": "2.0",
  "id": 101,
  "method": "subscribe",
  "params": {
    "method": "getSlot",
    "params": []
  }
}
```

**Example: Subscribe to Account Info Updates**

```json
{
  "jsonrpc": "2.0",
  "id": 102,
  "method": "subscribe",
  "params": {
    "method": "getAccountInfo",
    "params": ["4fYNw3dojWmQ4dXtSGE9epjRGy9pFSx62YypT7avPYvA"]
  }
}
```

## Receiving Confirmation

After sending a subscription request, the server will respond with a confirmation message containing the unique subscription ID generated by the server:

```json
{
  "jsonrpc": "2.0",
  "result": "SUBSCRIPTION_ID", // Server-generated subscription ID
  "id": 101 // Matches the ID from your request
}
```

You will need this `SUBSCRIPTION_ID` if you want to unsubscribe later.

## Receiving Updates

When the data for a subscribed method changes (based on the worker periodically checking and comparing results), the server will push an update message to your client:

```json
{
  "jsonrpc": "2.0",
  "method": "subscription",
  "params": {
    "subscription": "SUBSCRIPTION_ID", // The ID from the confirmation
    "result": {
      // The updated result from the Solana RPC method
    }
  },
  "responseTime": 25, // Response time for this update check
  "cacheHit": false // Whether this update check resulted in a cache hit
}
```

The worker checks subscriptions periodically. It only sends an update if the result of the underlying RPC call has changed since the last update sent for that subscription.

## Unsubscribing

To stop receiving updates for a specific subscription, send an unsubscribe message:

```json
{
  "jsonrpc": "2.0",
  "id": 201, // Your unique request ID
  "method": "unsubscribe",
  "params": [
    "SUBSCRIPTION_ID" // The ID received in the subscription confirmation
  ]
}
```

The server will confirm the unsubscription:

```json
{
  "jsonrpc": "2.0",
  "result": true,
  "id": 201 // Matches the ID from your request
}
```

## Notes

- The frequency of updates depends on the worker's internal polling mechanism and the cache TTLs for the subscribed methods. It's not guaranteed to be instant but provides updates without constant client polling.
- The worker manages subscriptions efficiently. If multiple clients subscribe to the exact same method and parameters, the worker only performs the underlying RPC check once.
- Closing the WebSocket connection automatically unsubscribes the client from all its active subscriptions on the server side.

---

*For questions or inquiries, please contact [hey@monostate.ai](mailto:hey@monostate.ai).*
